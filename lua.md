# 10. lua 模式匹配

## 10.1 模式匹配相关函数

模式匹配相关函数：`find` `gsub` `match` `gmatch`

函数 string.find 用于在指定的字符串中搜索指定的**模式**，找到模式后，会返回两个值：匹配到模式开始位置的索引和结束位置的索引。如果没有找到匹配就返回 nil 。

string.find 还有两个可选参数：第三个参数是表示从什么位置开始搜索。第四个参数表示是否启动简单搜索。

```lua
s = 'hello [world]'
string.match(s, "[") -- error: ‘【’在模式匹配中具有特殊含义
string.match(s, "[", 1, true); --> 3
```

函数 string.match 返回是与模式匹配的那部分字串

```lua
s = "hello world"
d = string.match(s, "hello");
print(d);
```

函数 string.gsub 有三个必选参数：目标字符串、模式和替换字符串。一个可选字符串：限制替换次数。

函数 string.gmatch 返回一个函数，通过这个函数，可以遍历所有出现在字符串中所有出现的指定模式。

```lua
s = 'some string'
words = {}
for w in string.gmatch(s, "%a+") do
    words[#words + 1] = w
end
```

## 10.2 模式

对于 lua 而言，模式仅仅是普通字符串。模式与普通的字符串遵循相同的规则，只有模式匹配相关的函数才会将其视为模式对待。lua 语言中的模式使用 ’%‘ 作为转义符。总体上，所有被转义的字符都具有某种特殊含义，而所有被转移的非字母则代表其自生。

**字符分类**：模式中能够与一个特定集合中的任意字符相匹配的一项。

| 转义字符 | 含义          |
| ---- | ----------- |
| .    | 任意字符        |
| %a   | 字母          |
| %c   | 控制字符        |
| %d   | 数字          |
| %g   | 除空格以外的可打印字符 |
| %l   | 小写字母        |
| %p   | 标点符号        |
| %s   | 空白字符        |
| %u   | 大写字母        |
| %w   | 字母和数字       |
| %x   | 十六进制数字      |

这些转移字符的大写形式表示的是类的补集，例如：‘%A' 表示的是任意非字母的字符。

特殊含义字符 `() . % + - * ? [ ] ^ $`

字符集：可以用来创建自定的字符分类，只需要在方括号内将单个字符和字符分类组合起来即可。

Lua 模式提供的四种修饰符：

| 修饰符 | 含义            |
|:---:|:-------------:|
| +   | 重复一次或多次       |
| *   | 重复零次或多次       |
| -   | 重复零次或多次（最小匹配） |
| ？   | 可选，出现零次或一次    |

Lua 中的修饰符，只能作用于一个字符模式，而无法作用于一组分类。（只能作用与单个字符或字符类别，不能作用与整个字符集）

## 10.3 捕获

捕获(capture)机制允许根据一个模式从目标字符串中抽取出与该模式匹配的内容来用于后续用途，可以通过把模式中需要捕获的部分放到一对圆括号内，以指定捕获。

函数 string.match() 会将所捕获到的值作为单独的结果返回(该函数会将字符串切分成多个被捕获的部分)。

```lua
pair = {"name = Anna"}
key, value = string.match(pair, "(%a+)%s*=%s*(%a)"
print(key, value) --> name Anna
```

在模式中，形如 `%n` 的分类(`n` 表示一个数字)，表示匹配到的第 n 各副本。

```lua
s = [[then he said: "it's all right"!]]
q, quotedPart = string.match(s, "([\"'])(.-)%1")
print(quotedPart)
```

捕获对象的第三个用途是在函数gsub的替代字符串中。当发生替换是，替换成相对应的捕获。特别的：`%0` 意味着整个匹配，替换的字符串中的百分号必须被转译为`%%`。

```lua
-- 重复字符串中的每个字母，并在每个重复字母之间插入一个减号
print(string.gsub("hello world", "%a", "%0-%0")) -->h-he-el-ll-lo-o l-lu-ua-a!
-- 一个原始的格式转换器
-- 将LATEX 转换为 XML
-- \command{some text} --> <command>some</command>
```
